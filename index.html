<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Locofly Ops â€“ Picking & Putaway</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/@zxing/library@latest"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 12px;
      background: #f4f4f4;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 8px 0;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
    }
    select, input, button {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      cursor: pointer;
      border: none;
    }
    button.primary {
      background: #0070f3;
      color: #fff;
    }
    button.secondary {
      background: #eee;
    }
    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .row > div {
      flex: 1;
    }
    #video {
      width: 100%;
      border-radius: 8px;
      background: #000;
    }
    #log {
      font-size: 12px;
      max-height: 220px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .small {
      font-size: 12px;
      color: #555;
    }
  </style>
</head>
<body>

<div class="card">
  <h1>Locofly Ops</h1>
  <div class="small">Picking &amp; Putaway app using live Locofly backend.</div>

  <div class="row" style="margin-top:8px;">
    <div>
      <label for="location">Location</label>
      <select id="location">
        <option value="">Loading...</option>
      </select>
    </div>
    <div>
      <label for="mode">Mode</label>
      <select id="mode">
        <option value="pick">Picking (decrement)</option>
        <option value="putaway">Putaway (increment)</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div>
      <label for="qty">Quantity per scan</label>
      <input id="qty" type="number" value="1" min="0.01" step="0.01" />
    </div>
    <div>
      <label>&nbsp;</label>
      <button id="toggleScan" class="primary">Start Scanner</button>
    </div>
  </div>

  <div class="small">
    Backend base URL:
    <code id="apiBaseDisplay"></code>
  </div>
</div>

<div class="card">
  <video id="video" muted playsinline></video>
</div>

<div class="card">
  <h3>Last Scan</h3>
  <div><strong>Barcode:</strong> <span id="lastBarcode">â€”</span></div>
  <div><strong>Item:</strong> <span id="lastItem">â€”</span></div>
  <div><strong>Location:</strong> <span id="lastLocation">â€”</span></div>
  <div><strong>Previous Qty:</strong> <span id="lastPrevQty">â€”</span></div>
  <div><strong>Delta:</strong> <span id="lastDelta">â€”</span></div>
  <div><strong>New Qty:</strong> <span id="lastNewQty">â€”</span></div>
  <div><strong>Status:</strong> <span id="lastStatus">â€”</span></div>
</div>

<div class="card">
  <h3>Event Log</h3>
  <div id="log"></div>
</div>

<script>
  const API_BASE = "https://locofly-backend-474391274468.asia-south1.run.app";
  document.getElementById("apiBaseDisplay").textContent = API_BASE;

  const locationSelect = document.getElementById("location");
  const modeSelect = document.getElementById("mode");
  const qtyInput = document.getElementById("qty");
  const toggleScanBtn = document.getElementById("toggleScan");
  const video = document.getElementById("video");
  const logEl = document.getElementById("log");

  const lastBarcodeEl = document.getElementById("lastBarcode");
  const lastItemEl = document.getElementById("lastItem");
  const lastLocationEl = document.getElementById("lastLocation");
  const lastPrevQtyEl = document.getElementById("lastPrevQty");
  const lastDeltaEl = document.getElementById("lastDelta");
  const lastNewQtyEl = document.getElementById("lastNewQty");
  const lastStatusEl = document.getElementById("lastStatus");

  let codeReader = null;
  let scanning = false;
  let lastScanTs = 0;
  const SCAN_COOLDOWN_MS = 900;

  function appendLog(msg, isError = false) {
    const ts = new Date().toLocaleTimeString();
    const prefix = isError ? "[ERR]" : "[OK]";
    logEl.textContent = `[${ts}] ${prefix} ${msg}\n` + logEl.textContent;
  }

  async function loadLocations() {
    try {
      const res = await fetch(API_BASE + "/locations");
      const data = await res.json();
      locationSelect.innerHTML = "<option value=''>Select location</option>";
      data.forEach(loc => {
        const opt = document.createElement("option");
        opt.value = loc.id;
        opt.textContent = loc.name + " (ID " + loc.id + ")";
        locationSelect.appendChild(opt);
      });
    } catch (e) {
      appendLog("Failed to load locations: " + e.message, true);
    }
  }

  async function handleScan(barcode) {
    const locId = locationSelect.value;
    const mode = modeSelect.value;
    const qtyVal = parseFloat(qtyInput.value || "0");

    lastBarcodeEl.textContent = barcode;

    if (!locId) {
      appendLog("Scan ignored: no location selected", true);
      lastStatusEl.textContent = "No location selected";
      return;
    }

    if (!qtyVal || qtyVal <= 0) {
      appendLog("Invalid quantity", true);
      lastStatusEl.textContent = "Invalid qty";
      return;
    }

    try {
      const searchUrl = `${API_BASE}/inventory?location_id=${locId}&query=${barcode}`;
      const res = await fetch(searchUrl);
      const items = await res.json();

      if (!items.length) {
        appendLog("No item found for barcode " + barcode, true);
        lastStatusEl.textContent = "No match found";
        return;
      }

      const item = items.find(i => i.barcode === barcode) || items[0];
      const prevQty = item.quantity;
      const delta = mode === "pick" ? -qtyVal : qtyVal;

      const adjRes = await fetch(API_BASE + "/inventory/adjust", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          location_id: Number(locId),
          items: [{ id: item.id, delta }]
        })
      });

      const adjData = await adjRes.json();
      const updated = adjData.updated?.[0];

      lastItemEl.textContent = item.item_name;
      lastLocationEl.textContent = item.location_id;
      lastPrevQtyEl.textContent = prevQty;
      lastDeltaEl.textContent = delta;
      lastNewQtyEl.textContent = updated?.quantity ?? "â€”";
      lastStatusEl.textContent = "OK";

      navigator.vibrate?.(100);

      appendLog(`SCAN OK: ${barcode} Î”${delta}`, false);

    } catch (e) {
      appendLog("Scan error: " + e.message, true);
      lastStatusEl.textContent = "Error";
    }
  }


  // ðŸ”¥ FIXED SCANNER: Back Camera + HD + tryHarder + Continuous Focus
  async function startScanner() {
    if (scanning) return;

    scanning = true;
    toggleScanBtn.textContent = "Stop Scanner";
    toggleScanBtn.classList.remove("primary");
    toggleScanBtn.classList.add("secondary");

    codeReader = new ZXing.BrowserMultiFormatReader(undefined, {
      delayBetweenScanAttempts: 120,
      tryHarder: true
    });

    const constraints = {
      video: {
        facingMode: { exact: "environment" },   // Forces proper back camera
        width: { ideal: 1920 },
        height: { ideal: 1080 },
        focusMode: "continuous"
      }
    };

    try {
      await codeReader.decodeFromConstraints(constraints, "video", (result, err) => {
        if (result) {
          const now = Date.now();
          if (now - lastScanTs < SCAN_COOLDOWN_MS) return;
          lastScanTs = now;
          handleScan(result.text);
        }
      });

      appendLog("Scanner started (Back Camera HD)");

    } catch (e) {
      appendLog("Scanner start failed: " + e.message, true);
      stopScanner();
    }
  }

  function stopScanner() {
    scanning = false;
    toggleScanBtn.textContent = "Start Scanner";
    toggleScanBtn.classList.add("primary");
    toggleScanBtn.classList.remove("secondary");
    codeReader?.reset();
    appendLog("Scanner stopped");
  }

  toggleScanBtn.addEventListener("click", () => {
    scanning ? stopScanner() : startScanner();
  });

  loadLocations();
</script>

</body>
</html>
